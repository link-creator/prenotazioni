<script>
    const translations = {
        en: { langLabel: "Language:", title: "ðŸ¾ Dog Sitting Luxury", lblFullname: "Full Name", lblPhone: "Phone Number", lblDuration: "Duration", opt1h: "1 hour", opt2h: "2 hours", opt3h: "3 hours", lblDogs: "Dogs", opt1d: "1 dog", opt2d: "2 dogs", dog1Place: "Dog's name", dog2Place: "Second dog's name", lblDate: "Date", lblStartTime: "Start time", lblPort: "Port", lblPontile: "Pier", lblNotes: "Notes", btnSubmit: "Send Form", successTitle: "Booking Sent!", btnPdf: "Download PDF Report", timeErrorMsg: "Error: Service available only 09:30-12:30 and 15:30-18:30", months: ["June 2024", "July 2024", "August 2024"], statusOpen: "We are Open!", statusClosed: "Service closed", tableTitle: "Business Hours", thDays: "Days", thHours: "Hours", tdMonTue: "Mon - Tue", tdWedSun: "Wed - Sun", tdClosed: "CLOSED", closedMsg: "Service closed Mon-Tue", meetingPoint: "The meeting point is at the pier entrance" },
        it: { langLabel: "Lingua:", title: "ðŸ¾ Dog Sitting Luxury", lblFullname: "Nome e Cognome", lblPhone: "Numero di Telefono", lblDuration: "Durata", opt1h: "1 ora", opt2h: "2 ore", opt3h: "3 ore", lblDogs: "Cani", opt1d: "1 cane", opt2d: "2 cani", dog1Place: "Nome del cane", dog2Place: "Nome del secondo cane", lblDate: "Giorno", lblStartTime: "Ora d'inizio", lblPort: "Porto", lblPontile: "Pontile", lblNotes: "Note", btnSubmit: "Invia Modulo", successTitle: "Prenotazione Inviata!", btnPdf: "Scarica Resoconto PDF", timeErrorMsg: "Errore: Servizio attivo solo 09:30-12:30 e 15:30-18:30", months: ["Giugno 2024", "Luglio 2024", "Agosto 2024"], statusOpen: "Siamo Aperti!", statusClosed: "Servizio chiuso", tableTitle: "Orari del Servizio", thDays: "Giorni", thHours: "Orari", tdMonTue: "Lun - Mar", tdWedSun: "Mer - Dom", tdClosed: "CHIUSO", closedMsg: "Servizio chiuso LunedÃ¬ e MartedÃ¬", meetingPoint: "Il punto di ritrovo Ã¨ all'inizio del pontile" }
    };

    let currentLang = 'en';
    let currentMonthIdx = 0;

    // FUNZIONE DI CONTROLLO STATO (Solo visiva, non blocca l'invio)
    function checkStatus() {
        const now = new Date();
        const day = now.getDay(); // 0=Dom, 1=Lun, 2=Mar...
        const hours = now.getHours();
        const minutes = now.getMinutes();
        const currentTime = hours + (minutes / 60);
        
        const t = translations[currentLang];
        
        // Aperto se: NON Ã¨ LunedÃ¬(1) e NON Ã¨ MartedÃ¬(2) 
        // AND (Mattina 09:30-12:30 OR Pomeriggio 15:30-18:30)
        let isOpen = (day !== 1 && day !== 2) && 
                     ((currentTime >= 9.5 && currentTime <= 12.5) || 
                      (currentTime >= 15.5 && currentTime <= 18.5));

        const box = document.getElementById('statusMessage');
        if (box) {
            box.innerText = isOpen ? t.statusOpen : t.statusClosed;
            box.className = "status-box " + (isOpen ? "status-open" : "status-closed");
        }
    }

    function changeLanguage() {
        currentLang = document.getElementById('langSelect').value;
        const t = translations[currentLang];
        
        // Aggiornamento testi
        document.getElementById('langLabel').innerText = t.langLabel;
        document.getElementById('title').innerText = t.title;
        document.getElementById('lblFullname').innerText = t.lblFullname;
        document.getElementById('lblPhone').innerText = t.lblPhone;
        document.getElementById('lblDuration').innerText = t.lblDuration;
        document.getElementById('opt1h').innerText = t.opt1h;
        document.getElementById('opt2h').innerText = t.opt2h;
        document.getElementById('opt3h').innerText = t.opt3h;
        document.getElementById('lblDogs').innerText = t.lblDogs;
        document.getElementById('opt1d').innerText = t.opt1d;
        document.getElementById('opt2d').innerText = t.opt2d;
        document.getElementById('dog1').placeholder = t.dog1Place;
        document.getElementById('dog2').placeholder = t.dog2Place;
        document.getElementById('lblDate').innerText = t.lblDate;
        document.getElementById('lblStartTime').innerText = t.lblStartTime;
        document.getElementById('lblPort').innerText = t.lblPort;
        document.getElementById('lblPontile').innerText = t.lblPontile;
        document.getElementById('lblNotes').innerText = t.lblNotes;
        document.getElementById('btnSubmit').innerText = t.btnSubmit;
        document.getElementById('successTitle').innerText = t.successTitle;
        document.getElementById('btnPdf').innerText = t.btnPdf;
        document.getElementById('meetingInfo').innerText = t.meetingPoint;
        document.getElementById('tableTitle').innerText = t.tableTitle;
        document.getElementById('thDays').innerText = t.thDays;
        document.getElementById('thHours').innerText = t.thHours;
        document.getElementById('tdMonTue').innerText = t.tdMonTue;
        document.getElementById('tdWedSun').innerText = t.tdWedSun;
        document.getElementById('tdClosed').innerText = t.tdClosed;
        
        checkStatus(); 
        renderCalendar();
    }

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        const display = document.getElementById('monthDisplay');
        const configs = [{d:30, o:5}, {d:31, o:0}, {d:31, o:3}];
        const m = configs[currentMonthIdx];
        const t = translations[currentLang];
        display.innerText = t.months[currentMonthIdx];
        grid.innerHTML = '';
        ['L','M','M','G','V','S','D'].forEach(d => grid.innerHTML += `<div class="day header">${d}</div>`);
        for(let i=0; i<m.o; i++) grid.innerHTML += `<div class="day empty"></div>`;
        for(let d=1; d<=m.d; d++) {
            const dayDiv = document.createElement('div'); dayDiv.className = 'day'; dayDiv.innerText = d;
            const dw = (m.o + d - 1) % 7;
            if(dw === 0 || dw === 1) { 
                dayDiv.classList.add('disabled'); 
                dayDiv.onclick = () => alert(t.closedMsg); 
            } else { 
                dayDiv.onclick = function() { 
                    document.querySelectorAll('.day').forEach(el => el.classList.remove('selected')); 
                    dayDiv.classList.add('selected'); 
                    document.getElementById('selectedDate').value = `${d} ${t.months[currentMonthIdx]}`; 
                }; 
            }
            grid.appendChild(dayDiv);
        }
    }

    function changeMonth(dir) { currentMonthIdx = Math.max(0, Math.min(2, currentMonthIdx + dir)); renderCalendar(); }
    function toggleDogNames() { document.getElementById('extraDog').classList.toggle('hidden', document.getElementById('dogCount').value === "1"); }

    async function submitForm() {
        const t = translations[currentLang];
        const selectedDate = document.getElementById('selectedDate').value;
        const startTime = document.getElementById('startTime').value;
        const errorDiv = document.getElementById('timeError');

        if(!selectedDate) return alert(currentLang === 'it' ? "Scegli un giorno!" : "Select a date!");
        if(!startTime) return alert(currentLang === 'it' ? "Scegli un orario!" : "Select a time!");

        // Controllo validitÃ  orario inserito nel campo
        const timeParts = startTime.split(':');
        const hour = parseInt(timeParts[0]) + (parseInt(timeParts[1]) / 60);
        const isTimeValid = (hour >= 9.5 && hour <= 12.5) || (hour >= 15.5 && hour <= 18.5);
        
        if(!isTimeValid) { 
            errorDiv.innerText = t.timeErrorMsg; 
            errorDiv.style.display = 'block'; 
            document.getElementById('startTime').style.borderColor = 'var(--danger-color)'; 
            return; 
        } else { 
            errorDiv.style.display = 'none'; 
            document.getElementById('startTime').style.borderColor = '#ddd'; 
        }

        const duration = document.getElementById('duration').value;
        const price = duration == "1" ? "10â‚¬" : duration == "2" ? "20â‚¬" : "25â‚¬";
        const formData = { 
            fullname: document.getElementById('fullname').value, 
            phone: document.getElementById('phone').value, 
            duration: duration + (currentLang === 'it' ? " ore" : " hours"), 
            dogCount: document.getElementById('dogCount').value, 
            dogNames: document.getElementById('dog1').value + (document.getElementById('dog2').value ? ", " + document.getElementById('dog2').value : ""), 
            selectedDate: selectedDate, 
            startTime: startTime, 
            marina: document.getElementById('port').value, 
            pontile: document.getElementById('pontile').value, 
            notes: document.getElementById('notes').value, 
            price: price 
        };

        const scriptURL = 'https://script.google.com/macros/s/AKfycbwPP-RM3qo2VcTal_xfk-ZfqwxO5UDOWInyXcOf8RKoDe1NXwH_ByjI3B91eMjdHtJj/exec';
        
        try { 
            await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(formData) }); 
            document.getElementById('finalPrice').innerText = price; 
            document.getElementById('successModal').style.display = 'flex'; 
        } catch (e) { 
            alert("Error sending!"); 
        }
    }

    function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const t = translations[currentLang];
        doc.setFontSize(22); doc.setTextColor(74, 124, 89); doc.text("DOG SITTING LUXURY", 105, 20, { align: "center" });
        doc.setFontSize(16); doc.setTextColor(0, 0, 0); doc.text(t.successTitle.toUpperCase(), 105, 35, { align: "center" });
        doc.setDrawColor(212, 163, 115); doc.line(20, 40, 190, 40);
        doc.setFontSize(12); let y = 55;
        const data = [ [t.lblFullname, document.getElementById('fullname').value], [t.lblPhone, document.getElementById('phone').value], [t.lblDate, document.getElementById('selectedDate').value], [t.lblStartTime, document.getElementById('startTime').value], [t.lblDuration, document.getElementById('duration').value + (currentLang === 'it' ? ' ore' : ' hour(s)')], [t.lblDogs, document.getElementById('dogCount').value + " (" + document.getElementById('dog1').value + (document.getElementById('dog2').value ? ', ' + document.getElementById('dog2').value : '') + ")"], [t.lblPort, document.getElementById('port').value], [t.lblPontile, document.getElementById('pontile').value], ["PRICE / PREZZO", document.getElementById('finalPrice').innerText] ];
        data.forEach(line => { doc.setFont("helvetica", "bold"); doc.text(line[0] + ":", 20, y); doc.setFont("helvetica", "normal"); doc.text(line[1], 70, y); y += 10; });
        y += 5; doc.setFont("helvetica", "bold"); doc.setTextColor(74, 124, 89); doc.text(t.meetingPoint, 20, y);
        if(document.getElementById('notes').value) { y += 10; doc.setFont("helvetica", "bold"); doc.setTextColor(0,0,0); doc.text(t.lblNotes + ":", 20, y); doc.setFont("helvetica", "normal"); doc.text(document.getElementById('notes').value, 20, y + 7, { maxWidth: 170 }); }
        doc.setFontSize(10); doc.setTextColor(150); const footer = currentLang === 'it' ? 'Grazie per aver scelto Dog Sitting Luxury!' : 'Thank you for choosing Dog Sitting Luxury!'; doc.text(footer, 105, 280, { align: "center" });
        doc.save(`Booking_Luxury_${document.getElementById('fullname').value}.pdf`);
    }

    // Caricamento iniziale corretto
    window.addEventListener('DOMContentLoaded', (event) => {
        changeLanguage();
        // Aggiorna lo stato ogni 30 secondi
        setInterval(checkStatus, 30000);
    });
</script>
